<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Forex Pranay • Vercel</title>
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
    <style>
      body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; padding: 16px; background: #0b1220; color: #e5e7eb; }
      .controls { display: grid; grid-template-columns: repeat(6, minmax(120px, 1fr)); gap: 12px; margin-bottom: 14px; }
      label { font-size: 12px; color: #9ca3af; display: block; margin-bottom: 6px; }
      input, select, button { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #374151; background: #111827; color: #e5e7eb; }
      button { background: #2563eb; border: none; cursor: pointer; }
      button:hover { background: #1d4ed8; }
      #chart { height: 72vh; }
      .meta { margin: 8px 0 12px; color: #9ca3af; font-size: 13px; }
      .err { color: #ef4444; font-size: 13px; margin-top: 8px; }
    </style>
  </head>
  <body>
    <h2>Forex Pranay — Vercel Dashboard</h2>
    <div class="controls">
      <div>
        <label>Pair</label>
        <select id="pair">
          <option>EURUSD</option>
          <option selected>USDJPY</option>
          <option>GBPUSD</option>
          <option>AUDUSD</option>
          <option>USDCHF</option>
        </select>
      </div>
      <div>
        <label>Timeframe</label>
        <select id="tf">
          <option>5m</option>
          <option>15m</option>
          <option>30m</option>
          <option>4h</option>
          <option selected>1d</option>
        </select>
      </div>
      <div>
        <label>Start</label>
        <input id="start" type="date" value="2015-01-01" />
      </div>
      <div>
        <label>End</label>
        <input id="end" type="date" value="2026-02-01" />
      </div>
      <div>
        <label>Auto refresh</label>
        <select id="refresh">
          <option value="0">Off</option>
          <option value="30">30s</option>
          <option value="60" selected>60s</option>
          <option value="120">120s</option>
        </select>
      </div>
      <div style="display:flex;align-items:end;">
        <button id="load">Load Chart</button>
      </div>
    </div>

    <div id="meta" class="meta">Loading...</div>
    <div id="chart"></div>
    <div id="err" class="err"></div>

    <script>
      let timer = null;

      async function loadChart() {
        const pair = document.getElementById('pair').value;
        const tf = document.getElementById('tf').value;
        const start = document.getElementById('start').value;
        const end = document.getElementById('end').value;
        const err = document.getElementById('err');
        const meta = document.getElementById('meta');
        err.textContent = '';
        meta.textContent = 'Loading...';

        try {
          const res = await fetch(`/api/ohlcv?pair=${pair}&timeframe=${tf}&start=${start}&end=${end}`);
          const payload = await res.json();
          if (!res.ok) throw new Error(payload.detail || 'Failed to fetch data');

          const candles = payload.data;
          const x = candles.map(c => c.datetime);
          const open = candles.map(c => c.open);
          const high = candles.map(c => c.high);
          const low = candles.map(c => c.low);
          const close = candles.map(c => c.close);

          const data = [{
            type: 'candlestick',
            x, open, high, low, close,
            increasing: { line: { color: '#10b981' } },
            decreasing: { line: { color: '#ef4444' } },
            name: `${pair} ${tf}`,
          }];

          const layout = {
            paper_bgcolor: '#0b1220',
            plot_bgcolor: '#0b1220',
            font: { color: '#e5e7eb' },
            xaxis: { rangeslider: { visible: false }, gridcolor: '#1f2937' },
            yaxis: { gridcolor: '#1f2937' },
            margin: { l: 40, r: 10, t: 20, b: 40 },
          };

          Plotly.newPlot('chart', data, layout, { responsive: true });
          meta.textContent = `Source: ${payload.source} | Candles: ${payload.count} | Range: ${payload.start} → ${payload.end}`;
        } catch (e) {
          err.textContent = e.message;
          meta.textContent = 'Load failed';
        }
      }

      function setupRefresh() {
        const refresh = Number(document.getElementById('refresh').value);
        if (timer) clearInterval(timer);
        if (refresh > 0) {
          timer = setInterval(loadChart, refresh * 1000);
        }
      }

      document.getElementById('load').addEventListener('click', () => {
        loadChart();
        setupRefresh();
      });
      document.getElementById('refresh').addEventListener('change', setupRefresh);

      loadChart();
      setupRefresh();
    </script>
  </body>
</html>
